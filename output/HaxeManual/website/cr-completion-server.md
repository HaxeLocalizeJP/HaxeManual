## 8.3.8 補完サーバー

コンパイルと補完を最速で行いたいのであれば、`--wait`のコマンドラインパラメータでHaxeの補完サーバーを立ち上げることができます。また、`-v`でサーバーがログを出力するようになります。以下が例です。

```haxe
haxe -v --wait 6000
```

こうすると、Haxeサーバーに接続して、コマンドラインパラメータを送って、最後にNULL文字を送ることで、レスポンスの読み取りができます（補完が成功の場合も失敗の場合も）。

`--connect`のコマンドラインのパラメータを使うことで、Haxeはコンパイルコマンドを直接実行するのではなくサーバーに送るようになります。

```haxe
haxe --connect 6000 myproject.hxml
```

はじめに`--cwd`のパラメータを使うことで、Haxeサーバーの現在の作業ディレクトリを変更することができることに気をつけてください。多くの場合クラスパスとそのほかのファイルはプロジェクトからの相対パスで指定されます。

##### 動作の詳細

コンパイルサーバーは以下の内容をキャッシュします。

* 構文解析したファイル ファイルは編集があせれたときが解析エラーになったときのみ再度構文解析が行われます。
* Haxelibの呼び出し 前回のHaxelibの呼び出し結果は再度利用されます（補完時のみです。コンパイルには関係ありません）
* 型付けされたモジュール モジュールのコンパイル結果はコンパイル成功した場合にキャッシュされて、その依存関係が更新されるまで補完とコンパイルに再利用されます。

コマンドラインで`--times`を追加することで、コンパイラが使用した正確な時間を取得して、コンパイルサーバーがどのような影響を与えたかを知ることができます。

##### プロトコル
次のHaxe/Nekoの例からわかるとおり、サーバーのポートに単純につないで、1行づつコマンドを送って、NULL文字で終了します。その後に結果を読み取ります。

マクロやその他のコマンドはエラー以外のログを出力することができます。コマンドラインからの実行の場合は、標準出力と標準エラー出力にプリントされるものの違いがありますが、ソケットモードの場合は違います。この2つを区別するために、ログメッセージ（エラーではない）は`x01`の文字から始まり、そのメッセージのすべての改行文字は`x01`で置き換えられます。

警告やそのほかのメッセージはエラーと考えられますが、致命的なものではありません。致命的なエラーが起こると、`x02`から始まる1行のメッセージが送られます。

以下にサーバーへ接続して、このプロトコルに従った処理を行うコードがあります。

```haxe
class Test {
    static function main() {
		var newline = "\n";
        var s = new neko.net.Socket();
        s.connect(new neko.net.Host("127.0.0.1"),6000);
        s.write("--cwd /my/project" + newline);
        s.write("myproject.hxml" + newline);
        s.write("\x00");
		
        var hasError = false;
        for (line in s.read().split(newline))
		{
            switch (line.charCodeAt(0)) {
				case 0x01: 
					neko.Lib.print(line.substr(1).split("\x01").join(newline));
				case 0x02: 
					hasError = true;
				default: 
					neko.io.File.stderr().writeString(line + newline);
            }
		}
        if (hasError) neko.Sys.exit(1);
    }
}

```

##### マクロの影響

コンパイルサーバーは[マクロの実行](macro.md)に副作用を与えます。

---

Previous section: [トップレベルの補完](cr-completion-top-level.md)

Next section: [リソース](cr-resources.md)